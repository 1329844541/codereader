<!DOCTYPE html>
<html>

  <head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Flume-NG源码分析-整体结构及配置载入分析</title>

	<link rel="shortcut icon" href="/styles/images/favicon.jpg">
	<link rel="icon" href="/styles/images/favicon.jpg">

	<link rel="stylesheet" href="/styles/css/index.css">
	<link rel="stylesheet" href="/styles/css/fontawesome/css/font-awesome.min.css">
	<link rel="canonical" href="/2016/10/17/Flume-NG%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84%E5%8F%8A%E9%85%8D%E7%BD%AE%E8%BD%BD%E5%85%A5%E5%88%86%E6%9E%90/">
	<link rel="alternate" type="application/rss+xml" title="源码分析" href="/feed.xml">
	
	<meta name="description" content="源码分析的博客">

	<script src="/styles/js/jquery.min.js"></script>
	<!--[if lt IE 9]>
    	<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  	<![endif]-->
               
  	<style type="text/css">
	  	.docs-content{
	  		margin-bottom: 10px;
	  	}
  	</style>
</head>


  <body class="index">

    <header class="navbar navbar-inverse navbar-fixed-top docs-nav" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="https://ymgd.github.io/codereader/" class="navbar-brand">
        <img src="/styles/images/logo.jpg">
      </a>
    </div>
    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
      <ul class="nav navbar-nav">    
        <li>
          <a href="/">时间流</a>
        </li>
        <li>
          <a href="/categories/">按项目分</a>
        </li>
        <li>
          <a href="/tag">按语言分</a>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">关于<b class="caret"></b></a>
          <ul class="dropdown-menu">
            <li><a rel="nofollow" target="_blank" href="https://github.com/ymgd/codereader">Github</a></li>
            <li><a href="/feed.xml">RSS订阅</a></li>
          </ul>
        </li>
      </ul>
    </nav>
  </div>
</header>

    <div class="docs-header" id="content">
  <div class="container">
  	
  		<!--
		    <h1>Flume-NG源码分析-整体结构及配置载入分析</h1>
		    <p>Post on Oct 17, 2016 by <a href="/about">ymgd</a></p>
		-->
		    <h3>I am reading codes</h3>
    
  </div>
</div>

    
      
<div class="banner">
  <div class="container">
  	
    	<a href="/categories/#Flume-ref">Flume</a>	/
    	<a href="/tag/#Java-ref">Java</a>
    
  </div>
</div>

    

    <div class="container docs-container">
  <div class="row">
    <div class="col-md-3">
      <div class="sidebar hidden-print" role="complementary">
        <div id="navigation">
  <h1>目录</h1>
  <ul class="nav sidenav">
<!--
    
      
      
      
      

      
        <li><a href="#year_2016">2016</a>
          <ul class="nav">
            <li><a href="#month_2016_November">November</a></li>
      

      
            
          
              <li><a href="#month_2016_October">October</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            </ul>
          </li>
      
    
-->
  </ul>
</div> 
      </div>
    </div>
    <div class="col-md-9" role="main">
      <div class="panel docs-content">
        <div class="wrapper">
            <header class="post-header">
              <h1 class="post-title">Flume-NG源码分析-整体结构及配置载入分析</h1>
              <!--
                <p class="post-meta">Oct 17, 2016</p>
              -->
              
                <div class="meta">Posted on <span class="postdate">Oct 17, 2016</span> By <a target="_blank" href="https://github.com/ymgd">ymgd</a></div>
              
              <br />
            </header>
            <article class="post-content">
              <blockquote>
  <p>弦外之音</p>

  <p>很多朋友都在问我，经常看各种框架的源码会不会感到很枯燥，是什么东西在驱动着我一直看下去。其实我想说的很简单，作为一个程序员，不管你工作了多少年，能够经常学习和借鉴国内外优秀框架设计思想和程序架构，我想对我们来说是最直接的提高。</p>
</blockquote>

<p>在 http://flume.apache.org 上下载flume-1.6.0版本，将源码导入到Idea开发工具后如下图所示：</p>

<p><img src="/bigdata/flume/resources/sourcestruc.png" alt="" /></p>

<h2 id="section">一、主要模块说明</h2>

<ul>
  <li>
    <p>flume-ng-channels
里面包含了filechannel，jdbcchannel，kafkachannel,memorychannel通道的实现。</p>
  </li>
  <li>
    <p>flume-ng-clients
实现了log4j相关的几个Appender，使得log4j的日志输出可以直接发送给flume-agent；其中有一个LoadBalancingLog4jAppender的实现，提供了多个flume-agent的load balance和ha功能，采用flume作为日志收集的可以考虑将这个appender引入内部的log4j中。</p>
  </li>
  <li>
    <p>flume-ng-configuration
这个主要就是Flume配置信息相关的类，包括载入flume-config.properties配置文件并解析。其中包括了Source的配置，Sink的配置，Channel的配置，在阅读源码前推荐先梳理这部分关系再看其他部分的。</p>
  </li>
  <li>
    <p>flume-ng-core
flume整个核心框架，包括了各个模块的接口以及逻辑关系实现。其中instrumentation是flume内部实现的一套metric机制，metric的变化和维护，其核心也就是在MonitoredCounterGroup中通过一个Map&lt;key, AtomicLong&gt;来实现metric的计量。ng-core下几乎大部分代码任然几种在channel、sink、source几个子目录下，其他目录基本完成一个util和辅助的功能。</p>
  </li>
  <li>
    <p>flume-ng-node
实现启动flume的一些基本类，包括main函数的入口（Application.java中）。在理解configuration之后，从application的main函数入手，可以较快的了解整个flume的代码。</p>
  </li>
</ul>

<h2 id="flume">二、Flume逻辑结构图</h2>

<p><img src="/bigdata/flume/resources/logicstruc.png" alt="" /></p>

<h2 id="flume-ng">三、flume-ng启动文件介绍</h2>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="c">################################</span>
<span class="c"># constants</span>
<span class="c">################################</span>

<span class="c">#设置常量值，主要是针对不同的参数执行相应的类，以启动Flume环境</span>
<span class="nv">FLUME_AGENT_CLASS</span><span class="o">=</span><span class="s2">"org.apache.flume.node.Application"</span>
<span class="nv">FLUME_AVRO_CLIENT_CLASS</span><span class="o">=</span><span class="s2">"org.apache.flume.client.avro.AvroCLIClient"</span>
<span class="nv">FLUME_VERSION_CLASS</span><span class="o">=</span><span class="s2">"org.apache.flume.tools.VersionInfo"</span>
<span class="nv">FLUME_TOOLS_CLASS</span><span class="o">=</span><span class="s2">"org.apache.flume.tools.FlumeToolsMain"</span>

<span class="c">#真正启动Flume环境的方法</span>
run_flume<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local </span>FLUME_APPLICATION_CLASS

  <span class="k">if</span> <span class="o">[</span> <span class="s2">"$#"</span> -gt 0 <span class="o">]</span>; <span class="k">then
    </span><span class="nv">FLUME_APPLICATION_CLASS</span><span class="o">=</span><span class="nv">$1</span>
    <span class="nb">shift
  </span><span class="k">else
    </span>error <span class="s2">"Must specify flume application class"</span> 1
  <span class="k">fi

  if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">CLEAN_FLAG</span><span class="k">}</span> -ne 0 <span class="o">]</span>; <span class="k">then
    </span><span class="nb">set</span> -x
  <span class="k">fi</span>

  <span class="c">#执行这一行命令，执行相应的启动类，比如org.apache.flume.node.Application</span>
  <span class="nv">$EXEC</span> <span class="nv">$JAVA_HOME</span>/bin/java <span class="nv">$JAVA_OPTS</span> <span class="nv">$FLUME_JAVA_OPTS</span> <span class="s2">"</span><span class="k">${</span><span class="nv">arr_java_props</span><span class="p">[@]</span><span class="k">}</span><span class="s2">"</span> -cp <span class="s2">"</span><span class="nv">$FLUME_CLASSPATH</span><span class="s2">"</span> <span class="se">\</span>
      -Djava.library.path<span class="o">=</span><span class="nv">$FLUME_JAVA_LIBRARY_PATH</span> <span class="s2">"</span><span class="nv">$FLUME_APPLICATION_CLASS</span><span class="s2">"</span> <span class="nv">$*</span>
<span class="o">}</span>


<span class="c">################################</span>
<span class="c"># main</span>
<span class="c">################################</span>

<span class="c"># set default params</span>
<span class="c"># 在启动的过程中使用到的参数</span>
<span class="nv">FLUME_CLASSPATH</span><span class="o">=</span><span class="s2">""</span>
<span class="nv">FLUME_JAVA_LIBRARY_PATH</span><span class="o">=</span><span class="s2">""</span>
<span class="c">#默认占用堆空间大小，这一块都可以根据JVM进行重新设置</span>
<span class="nv">JAVA_OPTS</span><span class="o">=</span><span class="s2">"-Xmx20m"</span>
<span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="s2">""</span>

<span class="nv">opt_conf</span><span class="o">=</span><span class="s2">""</span>
<span class="nv">opt_classpath</span><span class="o">=</span><span class="s2">""</span>
<span class="nv">opt_plugins_dirs</span><span class="o">=</span><span class="s2">""</span>
<span class="nv">arr_java_props</span><span class="o">=()</span>
<span class="nv">arr_java_props_ct</span><span class="o">=</span>0
<span class="nv">opt_dryrun</span><span class="o">=</span><span class="s2">""</span>

<span class="c"># 根据不同的参数，执行不同的启动类，每个常量所对应的类路径在代码前面有过介绍。</span>
<span class="k">if</span> <span class="o">[</span> -n <span class="s2">"</span><span class="nv">$opt_agent</span><span class="s2">"</span> <span class="o">]</span> ; <span class="k">then
  </span>run_flume <span class="nv">$FLUME_AGENT_CLASS</span> <span class="nv">$args</span>
<span class="k">elif</span> <span class="o">[</span> -n <span class="s2">"</span><span class="nv">$opt_avro_client</span><span class="s2">"</span> <span class="o">]</span> ; <span class="k">then
  </span>run_flume <span class="nv">$FLUME_AVRO_CLIENT_CLASS</span> <span class="nv">$args</span>
<span class="k">elif</span> <span class="o">[</span> -n <span class="s2">"</span><span class="k">${</span><span class="nv">opt_version</span><span class="k">}</span><span class="s2">"</span> <span class="o">]</span> ; <span class="k">then
  </span>run_flume <span class="nv">$FLUME_VERSION_CLASS</span> <span class="nv">$args</span>
<span class="k">elif</span> <span class="o">[</span> -n <span class="s2">"</span><span class="k">${</span><span class="nv">opt_tool</span><span class="k">}</span><span class="s2">"</span> <span class="o">]</span> ; <span class="k">then
  </span>run_flume <span class="nv">$FLUME_TOOLS_CLASS</span> <span class="nv">$args</span>
<span class="k">else
  </span>error <span class="s2">"This message should never appear"</span> 1
<span class="k">fi</span>
</code></pre>
</div>

<p>这是其中最主要的一部分flume-ng命令行，根据重要性摘取了一段，感兴趣的读者可以自己到bin目录下查看全部。</p>

<h2 id="flume-ng-1">四、从Flume-NG启动过程开始说起</h2>

<p>从bin/flume-ng这个shell脚本可以看到Flume的起始于org.apache.flume.node.Application类，这是flume的main函数所在。</p>

<p>main方法首先会先解析shell命令，如果指定的配置文件不存在就抛出异常。</p>

<p>代码如下所示：</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">Options</span> <span class="n">options</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Options</span><span class="o">();</span>
<span class="n">Option</span> <span class="n">option</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Option</span><span class="o">(</span><span class="s">"n"</span><span class="o">,</span> <span class="s">"name"</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="s">"the name of this agent"</span><span class="o">);</span>
<span class="n">option</span><span class="o">.</span><span class="na">setRequired</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">options</span><span class="o">.</span><span class="na">addOption</span><span class="o">(</span><span class="n">option</span><span class="o">);</span>

<span class="n">option</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Option</span><span class="o">(</span><span class="s">"f"</span><span class="o">,</span> <span class="s">"conf-file"</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span>
    <span class="s">"specify a config file (required if -z missing)"</span><span class="o">);</span>
<span class="n">option</span><span class="o">.</span><span class="na">setRequired</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
<span class="n">options</span><span class="o">.</span><span class="na">addOption</span><span class="o">(</span><span class="n">option</span><span class="o">);</span>

<span class="n">option</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Option</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="s">"no-reload-conf"</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span>
    <span class="s">"do not reload config file if changed"</span><span class="o">);</span>
<span class="n">options</span><span class="o">.</span><span class="na">addOption</span><span class="o">(</span><span class="n">option</span><span class="o">);</span>

<span class="c1">// Options for Zookeeper</span>
<span class="n">option</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Option</span><span class="o">(</span><span class="s">"z"</span><span class="o">,</span> <span class="s">"zkConnString"</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span>
    <span class="s">"specify the ZooKeeper connection to use (required if -f missing)"</span><span class="o">);</span>
<span class="n">option</span><span class="o">.</span><span class="na">setRequired</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
<span class="n">options</span><span class="o">.</span><span class="na">addOption</span><span class="o">(</span><span class="n">option</span><span class="o">);</span>

<span class="n">option</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Option</span><span class="o">(</span><span class="s">"p"</span><span class="o">,</span> <span class="s">"zkBasePath"</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span>
    <span class="s">"specify the base path in ZooKeeper for agent configs"</span><span class="o">);</span>
<span class="n">option</span><span class="o">.</span><span class="na">setRequired</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
<span class="n">options</span><span class="o">.</span><span class="na">addOption</span><span class="o">(</span><span class="n">option</span><span class="o">);</span>

<span class="n">option</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Option</span><span class="o">(</span><span class="s">"h"</span><span class="o">,</span> <span class="s">"help"</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="s">"display help text"</span><span class="o">);</span>
<span class="n">options</span><span class="o">.</span><span class="na">addOption</span><span class="o">(</span><span class="n">option</span><span class="o">);</span>

 <span class="err">#命令行解析类</span>
<span class="n">CommandLineParser</span> <span class="n">parser</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GnuParser</span><span class="o">();</span>
<span class="n">CommandLine</span> <span class="n">commandLine</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">options</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>

<span class="k">if</span> <span class="o">(</span><span class="n">commandLine</span><span class="o">.</span><span class="na">hasOption</span><span class="o">(</span><span class="sc">'h'</span><span class="o">))</span> <span class="o">{</span>
  <span class="k">new</span> <span class="nf">HelpFormatter</span><span class="o">().</span><span class="na">printHelp</span><span class="o">(</span><span class="s">"flume-ng agent"</span><span class="o">,</span> <span class="n">options</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
  <span class="k">return</span><span class="o">;</span>
<span class="o">}</span>

<span class="n">String</span> <span class="n">agentName</span> <span class="o">=</span> <span class="n">commandLine</span><span class="o">.</span><span class="na">getOptionValue</span><span class="o">(</span><span class="sc">'n'</span><span class="o">);</span>
<span class="kt">boolean</span> <span class="n">reload</span> <span class="o">=</span> <span class="o">!</span><span class="n">commandLine</span><span class="o">.</span><span class="na">hasOption</span><span class="o">(</span><span class="s">"no-reload-conf"</span><span class="o">);</span>

<span class="k">if</span> <span class="o">(</span><span class="n">commandLine</span><span class="o">.</span><span class="na">hasOption</span><span class="o">(</span><span class="sc">'z'</span><span class="o">)</span> <span class="o">||</span> <span class="n">commandLine</span><span class="o">.</span><span class="na">hasOption</span><span class="o">(</span><span class="s">"zkConnString"</span><span class="o">))</span> <span class="o">{</span>
  <span class="n">isZkConfigured</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</code></pre>
</div>

<p>以上代码是Application类中校验shell命令行的代码，举个例子在启动flume的时候，使用如下命令行：</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>./bin/flume-ng agent -n agent -c conf -f conf/hw.conf -Dflume.root.logger<span class="o">=</span>INFO,console
</code></pre>
</div>

<p>里面的-n -f等参数都是在上面代码中校验的。</p>

<p>再往下看main方法里的代码：</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">File</span> <span class="n">configurationFile</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">commandLine</span><span class="o">.</span><span class="na">getOptionValue</span><span class="o">(</span><span class="sc">'f'</span><span class="o">));</span>

  <span class="cm">/*
   * The following is to ensure that by default the agent will fail on
   * startup if the file does not exist.
   */</span>
  <span class="k">if</span> <span class="o">(!</span><span class="n">configurationFile</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
    <span class="c1">// If command line invocation, then need to fail fast</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">Constants</span><span class="o">.</span><span class="na">SYSPROP_CALLED_FROM_SERVICE</span><span class="o">)</span> <span class="o">==</span>
      <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">configurationFile</span><span class="o">.</span><span class="na">getPath</span><span class="o">();</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">configurationFile</span><span class="o">.</span><span class="na">getCanonicalPath</span><span class="o">();</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Failed to read canonical path for file: "</span> <span class="o">+</span> <span class="n">path</span><span class="o">,</span>
          <span class="n">ex</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">ParseException</span><span class="o">(</span>
        <span class="s">"The specified configuration file does not exist: "</span> <span class="o">+</span> <span class="n">path</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="n">List</span><span class="o">&lt;</span><span class="n">LifecycleAware</span><span class="o">&gt;</span> <span class="n">components</span> <span class="o">=</span> <span class="n">Lists</span><span class="o">.</span><span class="na">newArrayList</span><span class="o">();</span>

  <span class="k">if</span> <span class="o">(</span><span class="n">reload</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">EventBus</span> <span class="n">eventBus</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EventBus</span><span class="o">(</span><span class="n">agentName</span> <span class="o">+</span> <span class="s">"-event-bus"</span><span class="o">);</span>
    <span class="n">PollingPropertiesFileConfigurationProvider</span> <span class="n">configurationProvider</span> <span class="o">=</span>
      <span class="k">new</span> <span class="nf">PollingPropertiesFileConfigurationProvider</span><span class="o">(</span>
        <span class="n">agentName</span><span class="o">,</span> <span class="n">configurationFile</span><span class="o">,</span> <span class="n">eventBus</span><span class="o">,</span> <span class="mi">30</span><span class="o">);</span>
    <span class="n">components</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">configurationProvider</span><span class="o">);</span>
    <span class="n">application</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Application</span><span class="o">(</span><span class="n">components</span><span class="o">);</span>
    <span class="n">eventBus</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">application</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">PropertiesFileConfigurationProvider</span> <span class="n">configurationProvider</span> <span class="o">=</span>
      <span class="k">new</span> <span class="nf">PropertiesFileConfigurationProvider</span><span class="o">(</span>
        <span class="n">agentName</span><span class="o">,</span> <span class="n">configurationFile</span><span class="o">);</span>
    <span class="n">application</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Application</span><span class="o">();</span>
    <span class="n">application</span><span class="o">.</span><span class="na">handleConfigurationEvent</span><span class="o">(</span><span class="n">configurationProvider</span>
      <span class="o">.</span><span class="na">getConfiguration</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="n">application</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</code></pre>
</div>

<p>说明：</p>

<p>根据命令中含有”no-reload-conf”参数，决定采用那种加载配置文件方式：</p>

<p>一、没有此参数，会动态加载配置文件，默认每30秒加载一次配置文件，因此可以动态修改配置文件；</p>

<p>二、有此参数，则只在启动时加载一次配置文件。实现动态加载功能采用了发布订阅模式，使用guava中的EventBus实现。</p>

<p>三、PropertiesFileConfigurationProvider这个类是配置文件加载类。</p>

<p>类图如下：</p>

<p><img src="/bigdata/flume/resources/configurationprovider.png" alt="" /></p>

<p><img src="/bigdata/flume/resources/configurationprovider2.png" alt="" /></p>

<p>从图中可以看出在整个PollingPropertiesFileConfigurationProvider类中，它实现了LifecycleAware接口，而这个接口是掌管整个Flume生命周期的一个核心接口，LifecycleSupervisor实现了这个接口，通过上面代码中application.start方法触发LifecyleAware的start方法，下面是这个接口的方法定义及相关类代码：</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">LifecycleAware</span> <span class="o">{</span>

  <span class="cm">/**
   * &lt;p&gt;
   * Starts a service or component.
   * &lt;/p&gt;
   * @throws LifecycleException
   * @throws InterruptedException
   */</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">();</span>

  <span class="cm">/**
   * &lt;p&gt;
   * Stops a service or component.
   * &lt;/p&gt;
   * @throws LifecycleException
   * @throws InterruptedException
   */</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">stop</span><span class="o">();</span>

  <span class="cm">/**
   * &lt;p&gt;
   * Return the current state of the service or component.
   * &lt;/p&gt;
   */</span>
  <span class="kd">public</span> <span class="n">LifecycleState</span> <span class="nf">getLifecycleState</span><span class="o">();</span>

<span class="o">}</span>
</code></pre>
</div>

<p>Application.start()方法内容:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">for</span><span class="o">(</span><span class="n">LifecycleAware</span> <span class="n">component</span> <span class="o">:</span> <span class="n">components</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">supervisor</span><span class="o">.</span><span class="na">supervise</span><span class="o">(</span><span class="n">component</span><span class="o">,</span>
        <span class="k">new</span> <span class="n">SupervisorPolicy</span><span class="o">.</span><span class="na">AlwaysRestartPolicy</span><span class="o">(),</span> <span class="n">LifecycleState</span><span class="o">.</span><span class="na">START</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>LifecycleSupervisor.supervise方法内容如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>public synchronized void supervise(LifecycleAware lifecycleAware,
    SupervisorPolicy policy, LifecycleState desiredState) {
  if(this.monitorService.isShutdown()
      || this.monitorService.isTerminated()
      || this.monitorService.isTerminating()){
    throw new FlumeException("Supervise called on " + lifecycleAware + " " +
        "after shutdown has been initiated. " + lifecycleAware + " will not" +
        " be started");
  }

  Preconditions.checkState(!supervisedProcesses.containsKey(lifecycleAware),
      "Refusing to supervise " + lifecycleAware + " more than once");

  if (logger.isDebugEnabled()) {
    logger.debug("Supervising service:{} policy:{} desiredState:{}",
        new Object[] { lifecycleAware, policy, desiredState });
  }

  Supervisoree process = new Supervisoree();
  process.status = new Status();

  process.policy = policy;
  process.status.desiredState = desiredState;
  process.status.error = false;

  MonitorRunnable monitorRunnable = new MonitorRunnable();
  monitorRunnable.lifecycleAware = lifecycleAware;
  monitorRunnable.supervisoree = process;
  monitorRunnable.monitorService = monitorService;

  supervisedProcesses.put(lifecycleAware, process);

  ScheduledFuture&lt;?&gt; future = monitorService.scheduleWithFixedDelay(
      monitorRunnable, 0, 3, TimeUnit.SECONDS);
  monitorFutures.put(lifecycleAware, future);
}
</code></pre>
</div>

<p>在上面的代码中，会创建MonitorRunnable对象，这个对象是个定时对象，里面的run方法主要是根据supervisoree.status.desiredState的值执行对应的操作。</p>

<p>包括：START，STOP等状态， 大家注意scheduleWithFixedDelay这个方法，这是java线程池自带的，要求每次任务执行完以后再延迟3秒，而不是每隔3秒执行一次，大家注意这一点。</p>

<p>又有同学会问循环调用会不会有问题，这里回应大家其实也没问题，这么做是为了重试机制，看下面代码：</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="k">if</span> <span class="o">(!</span><span class="n">lifecycleAware</span><span class="o">.</span><span class="na">getLifecycleState</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span> <span class="n">supervisoree</span><span class="o">.</span><span class="na">status</span><span class="o">.</span><span class="na">desiredState</span><span class="o">))</span>
</code></pre>
</div>

<p>在MonitorRunnable内部有这样一个判断，当getLifecycleState与supervisoree.status.desiredState状态不相等的时候才会执行，而ifecycleAware.getLifecycleState()初始状态是IDLE。</p>

<p>时序调用图如下所示</p>

<p><img src="/bigdata/flume/resources/timeline.png" alt="" /></p>

<p>注：</p>

<p>PollingPropertiesFileConfigurationProvider.start()方法会启动一个单线程FileWatcherRunnable每隔30s去加载一次配置文件：</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">eventBus</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="n">getConfiguration</span><span class="o">())</span><span class="err">。</span>
</code></pre>
</div>

<p>getConfiguration()解析了配置文件并且获取所有组件及配置属性</p>

<h2 id="section-1">五、配置文件加载详细分析</h2>

<p>先看一下FileWatcherRunnable内部的代码：</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="n">MaterializedConfiguration</span> <span class="nf">getConfiguration</span><span class="o">()</span> <span class="o">{</span>
 <span class="c1">//初始化三大组件的配置Map，source，channel，sink</span>
  <span class="n">MaterializedConfiguration</span> <span class="n">conf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleMaterializedConfiguration</span><span class="o">();</span>
  <span class="n">FlumeConfiguration</span> <span class="n">fconfig</span> <span class="o">=</span> <span class="n">getFlumeConfiguration</span><span class="o">();</span>
  <span class="n">AgentConfiguration</span> <span class="n">agentConf</span> <span class="o">=</span> <span class="n">fconfig</span><span class="o">.</span><span class="na">getConfigurationFor</span><span class="o">(</span><span class="n">getAgentName</span><span class="o">());</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">agentConf</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">ChannelComponent</span><span class="o">&gt;</span> <span class="n">channelComponentMap</span> <span class="o">=</span> <span class="n">Maps</span><span class="o">.</span><span class="na">newHashMap</span><span class="o">();</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">SourceRunner</span><span class="o">&gt;</span> <span class="n">sourceRunnerMap</span> <span class="o">=</span> <span class="n">Maps</span><span class="o">.</span><span class="na">newHashMap</span><span class="o">();</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">SinkRunner</span><span class="o">&gt;</span> <span class="n">sinkRunnerMap</span> <span class="o">=</span> <span class="n">Maps</span><span class="o">.</span><span class="na">newHashMap</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">loadChannels</span><span class="o">(</span><span class="n">agentConf</span><span class="o">,</span> <span class="n">channelComponentMap</span><span class="o">);</span>
      <span class="n">loadSources</span><span class="o">(</span><span class="n">agentConf</span><span class="o">,</span> <span class="n">channelComponentMap</span><span class="o">,</span> <span class="n">sourceRunnerMap</span><span class="o">);</span>
      <span class="n">loadSinks</span><span class="o">(</span><span class="n">agentConf</span><span class="o">,</span> <span class="n">channelComponentMap</span><span class="o">,</span> <span class="n">sinkRunnerMap</span><span class="o">);</span>
      <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">channelNames</span> <span class="o">=</span>
          <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;(</span><span class="n">channelComponentMap</span><span class="o">.</span><span class="na">keySet</span><span class="o">());</span>
      <span class="k">for</span><span class="o">(</span><span class="n">String</span> <span class="n">channelName</span> <span class="o">:</span> <span class="n">channelNames</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ChannelComponent</span> <span class="n">channelComponent</span> <span class="o">=</span> <span class="n">channelComponentMap</span><span class="o">.</span>
            <span class="nf">get</span><span class="o">(</span><span class="n">channelName</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">channelComponent</span><span class="o">.</span><span class="na">components</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
          <span class="n">LOGGER</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Channel %s has no components connected"</span> <span class="o">+</span>
              <span class="s">" and has been removed."</span><span class="o">,</span> <span class="n">channelName</span><span class="o">));</span>
          <span class="n">channelComponentMap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">channelName</span><span class="o">);</span>
          <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Channel</span><span class="o">&gt;</span> <span class="n">nameChannelMap</span> <span class="o">=</span> <span class="n">channelCache</span><span class="o">.</span>
              <span class="nf">get</span><span class="o">(</span><span class="n">channelComponent</span><span class="o">.</span><span class="na">channel</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
          <span class="k">if</span><span class="o">(</span><span class="n">nameChannelMap</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">nameChannelMap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">channelName</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Channel %s connected to %s"</span><span class="o">,</span>
              <span class="n">channelName</span><span class="o">,</span> <span class="n">channelComponent</span><span class="o">.</span><span class="na">components</span><span class="o">.</span><span class="na">toString</span><span class="o">()));</span>
          <span class="n">conf</span><span class="o">.</span><span class="na">addChannel</span><span class="o">(</span><span class="n">channelName</span><span class="o">,</span> <span class="n">channelComponent</span><span class="o">.</span><span class="na">channel</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">for</span><span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">SourceRunner</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">sourceRunnerMap</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">conf</span><span class="o">.</span><span class="na">addSourceRunner</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
      <span class="o">}</span>
      <span class="k">for</span><span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">SinkRunner</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">sinkRunnerMap</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">conf</span><span class="o">.</span><span class="na">addSinkRunner</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InstantiationException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Failed to instantiate component"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">channelComponentMap</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
      <span class="n">sourceRunnerMap</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
      <span class="n">sinkRunnerMap</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"No configuration found for this host:{}"</span><span class="o">,</span> <span class="n">getAgentName</span><span class="o">());</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">conf</span><span class="o">;</span>
<span class="o">}</span>
</code></pre>
</div>

<p>说明:</p>

<p>一、在哪里加载的配置文件</p>

<p>其实是在这里，FlumeConfiguration fconfig = getFlumeConfiguration();</p>

<p>getFlumeConfiguration()这个方法是一个抽象方法，可以通过下图的方式查找加载方式。</p>

<p><img src="/bigdata/flume/resources/flumeconfiguration.png" alt="" /></p>

<p>我们选择PollingPropertiesFileConfigurationProvider这个，可以看到：</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">FlumeConfiguration</span> <span class="nf">getFlumeConfiguration</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="n">FileReader</span><span class="o">(</span><span class="n">file</span><span class="o">));</span>
    <span class="n">Properties</span> <span class="n">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
    <span class="n">properties</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">reader</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">FlumeConfiguration</span><span class="o">(</span><span class="n">toMap</span><span class="o">(</span><span class="n">properties</span><span class="o">));</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Unable to load file:"</span> <span class="o">+</span> <span class="n">file</span>
        <span class="o">+</span> <span class="s">" (I/O failure) - Exception follows."</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">reader</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="n">reader</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span>
            <span class="s">"Unable to close file reader for file: "</span> <span class="o">+</span> <span class="n">file</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nf">FlumeConfiguration</span><span class="o">(</span><span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;());</span>
<span class="o">}</span>
</code></pre>
</div>

<p><img src="/bigdata/flume/resources/configfile.png" alt="" /></p>

<p>就是上面这个方法通过JAVA最基本的流的方式加载的配置文件，也就是图上面我配置的flume的hw.conf配置文件。方法读取配置文件，然后解析成name（输姓名全称，即等号左侧的全部）、value（等号的右侧）对，存入一个Map当中，返回一个封装了这个Map的FlumeConfiguration对象。</p>

<p>FlumeConfiguration类的构造函数会遍历这个Map的所有&lt;name,value&gt;对，调用addRawProperty(String name, String value)处理&lt;name,value&gt;对，addRawProperty方法会先做一些合法性检查，启动Flume的时候会构造一个AgentConfiguration对象aconf，然后agentConfigMap.put(agentName, aconf)，以后动态加载配置文件时只需要AgentConfiguration aconf = agentConfigMap.get(agentName)就可以得到，然后调用aconf.addProperty(configKey, value)处理。</p>

<p>二、我们重点看一下addProperty方法内部的parseConfigKey方法，这里会深入解析每一行配置文件内容。</p>

<p>我们举一个配置文件的例子：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>agent.sources=s1
agent.channels=c1 c2
agent.sinks=k1 k2

agent.sources.s1.type=exec
agent.sources.s1.command=tail -F /Users/it-od-m-2687/Downloads/abc.log
agent.sources.s1.channels=c1
agent.channels.c1.type=memory
agent.channels.c1.capacity=10000
agent.channels.c1.transactionCapacity=100

agent.sinks.k1.type= org.apache.flume.sink.kafka.KafkaSink
agent.sinks.k1.brokerList=127.0.0.1:9092

agent.sinks.k1.topic=testKJ1
agent.sinks.k1.serializer.class=kafka.serializer.StringEncoder

agent.sinks.k1.channel=c1
</code></pre>
</div>

<p>解析上面的文件就是使用下面parseConfigKey这个方法：</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">cnck</span> <span class="o">=</span> <span class="n">parseConfigKey</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">BasicConfigurationConstants</span><span class="o">.</span><span class="na">CONFIG_SINKGROUPS_PREFIX</span><span class="o">);</span>
</code></pre>
</div>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">BasicConfigurationConstants</span> <span class="o">{</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CONFIG_SOURCES</span> <span class="o">=</span> <span class="s">"sources"</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CONFIG_SOURCES_PREFIX</span> <span class="o">=</span> <span class="n">CONFIG_SOURCES</span> <span class="o">+</span> <span class="s">"."</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CONFIG_SOURCE_CHANNELSELECTOR_PREFIX</span> <span class="o">=</span> <span class="s">"selector."</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CONFIG_SINKS</span> <span class="o">=</span> <span class="s">"sinks"</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CONFIG_SINKS_PREFIX</span> <span class="o">=</span> <span class="n">CONFIG_SINKS</span> <span class="o">+</span> <span class="s">"."</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CONFIG_SINK_PROCESSOR_PREFIX</span> <span class="o">=</span> <span class="s">"processor."</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CONFIG_SINKGROUPS</span> <span class="o">=</span> <span class="s">"sinkgroups"</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CONFIG_SINKGROUPS_PREFIX</span> <span class="o">=</span> <span class="n">CONFIG_SINKGROUPS</span> <span class="o">+</span> <span class="s">"."</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CONFIG_CHANNEL</span> <span class="o">=</span> <span class="s">"channel"</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CONFIG_CHANNELS</span> <span class="o">=</span> <span class="s">"channels"</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CONFIG_CHANNELS_PREFIX</span> <span class="o">=</span> <span class="n">CONFIG_CHANNELS</span> <span class="o">+</span> <span class="s">"."</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CONFIG_CONFIG</span> <span class="o">=</span> <span class="s">"config"</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CONFIG_TYPE</span> <span class="o">=</span> <span class="s">"type"</span><span class="o">;</span>

<span class="kd">private</span> <span class="nf">BasicConfigurationConstants</span><span class="o">()</span> <span class="o">{</span>
  <span class="c1">// disable explicit object creation</span>
<span class="o">}</span>
</code></pre>
</div>

<p>1、我们用agent.sources.s1.command=s1来举例：</p>

<p>变量prefix指的是：sink,source,channel等关键字。</p>

<p>如下面代码：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>public final class BasicConfigurationConstants {

public static final String CONFIG_SOURCES = "sources";
public static final String CONFIG_SOURCES_PREFIX = CONFIG_SOURCES + ".";
public static final String CONFIG_SOURCE_CHANNELSELECTOR_PREFIX = "selector.";

public static final String CONFIG_SINKS = "sinks";
public static final String CONFIG_SINKS_PREFIX = CONFIG_SINKS + ".";
public static final String CONFIG_SINK_PROCESSOR_PREFIX = "processor.";

public static final String CONFIG_SINKGROUPS = "sinkgroups";
public static final String CONFIG_SINKGROUPS_PREFIX = CONFIG_SINKGROUPS + ".";

public static final String CONFIG_CHANNEL = "channel";
public static final String CONFIG_CHANNELS = "channels";
public static final String CONFIG_CHANNELS_PREFIX = CONFIG_CHANNELS + ".";

public static final String CONFIG_CONFIG = "config";
public static final String CONFIG_TYPE = "type";

private BasicConfigurationConstants() {
  // disable explicit object creation
}
</code></pre>
</div>

<p>2、上面parseConfigKey方法，首先根据prefix判断prefix的后面，有少多字符。比如：sources.s1.command，在sources后面s1.command一共有10个字符。</p>

<p>3、解析出name变量，如s1，这个是自己定义的。</p>

<p>4、解析出configKey固定关键字，如command，这个是系统定义的。</p>

<p>5、封装new ComponentNameAndConfigKey(name, configKey)返回。</p>

<p>6、将sources、channel、sink配置信息，分别存放到sourceContextMap、channelConfigMap、sinkConfigMap三个HashMap，最后统一封装到AgentConfiguration对象中，然后再把AgentConfiguration存放到agentConfigMap中，key是agentName。说了这么多相信很多同学都已经晕了，agentConfigMap的结构如下图所示：</p>

<p><img src="/bigdata/flume/resources/agentconfigmap.png" alt="" /></p>

<blockquote>
  <p>读源码是一个很痛苦的过程，不仅要分析整体框架的架构，还要理解作者的用意和设计思想，但只要坚持下来你会发现还是能学到很多东西的。</p>
</blockquote>


            </article>
        </div>
      </div>
      <div class="panel docs-content">
        <article class="post-content">
          <div class="wrapper">
            


  <div class="ds-thread" data-thread-key="/2016/10/17/Flume-NG%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84%E5%8F%8A%E9%85%8D%E7%BD%AE%E8%BD%BD%E5%85%A5%E5%88%86%E6%9E%90/" data-title="Flume-NG源码分析-整体结构及配置载入分析" data-url="https://ymgd.github.io/codereader/2016/10/17/Flume-NG%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E6%95%B4%E4%BD%93%E7%BB%93%E6%9E%84%E5%8F%8A%E9%85%8D%E7%BD%AE%E8%BD%BD%E5%85%A5%E5%88%86%E6%9E%90/"></div>

<script type="text/javascript">
var duoshuoQuery = {short_name:"luoyan35714"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
</script>


 
          </div>
        </article>
      </div>
    </div>
  </div>
</div>

    
    <footer class="footer" role="contentinfo">
	<div class="container">
		<p class="copyright">Copyright &copy; 2014-2018 <a href=""><code>ymgd</code></a>.</p>
		<p>Powered by <a href="http://jekyllrb.com">Jekyll</a>, theme from <a href="http://lesscss.cn/">Less</a></p>
	</div>
</footer>

<script src="/styles/js/jquery.min.js"></script>
<script src="/styles/js/bootstrap.min.js"></script>
<script src="/styles/js/holder.min.js"></script>
<script src="/styles/js/application.js"></script>
<script src="/styles/js/lessismore.js"></script>

  </body>
</html>
